name: Generate ZSM Pull Request

on: 
    workflow_dispatch:
      inputs:
        ZSM_URL:
          description: 'URL to the ZSM .kml file'     
          required: true
          default: 'https://www.stac.aviation-civile.gouv.fr/sites/default/files/france_1.kml' 

jobs:
    Download-Convert-ZSM-File:
        name: Download and convert ZSM file
        runs-on: ubuntu-latest

        steps:
        - name: ðŸšš Get latest code
          uses: actions/checkout@v2

        - name: Get current date
          id: date
          run: echo "::set-output name=date::$(date +'%Y-%m-%d')"

        - name: Create and checkout new branch
          run: |
            current_date=${{ steps.date.outputs.date }}

            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git config --global user.name "github-actions[bot]"
            git checkout -b autogenerated/zsm-$current_date

        - name: Download and convert ZSM file
          id: download-convert
          run: |
            current_date=${{ steps.date.outputs.date }}

            echo "## Install openaip-openair-parser"
            git clone https://github.com/llauner/kml2OpenAir.git
            cd kml2OpenAir
            npm install
            echo "## Downloading and converting kmlfile ...: ${{ github.event.inputs.ZSM_URL }}"
            node ./main.js ${{ github.event.inputs.ZSM_URL }} ./zsm_openair.txt

            git add .
            git commit -m "Autogenerated ZSM file on $current_date"
            git push origin autogenerated/zsm-$current_date
